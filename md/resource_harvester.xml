<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Entropic_ResourceHarvester" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>
    <cue name="Init">
      <conditions>
        <check_any>
          <event_cue_signalled cue="md.Setup.Start" />
          <event_game_loaded />
        </check_any>
      </conditions>
      <actions>
        <debug_text text="'Entropic Resource Harvester: Started'" />
      </actions>
      <cues>
        <cue name="HarvestCycle">
          <delay exact="60s" />
          <actions>
            <set_value name="$hq" exact="player.headquarters" />
            <do_if value="$hq">
              <set_value name="$sector" exact="$hq.sector" />
              <!-- Only proceed if we are in a valid sector -->
              <do_if value="$sector">
                <debug_text text="'Entropic Resource Harvester: Checking sector ' + $sector.knownname" />
                
                <!-- Define resources to check -->
                <!-- Dynamically find all minable resources in the game -->
                <set_value name="$resources" exact="[]" />
                <do_for_each name="$ware" in="lookup.wares.list">
                  <do_if value="$ware.tags.indexof.{tag.minable}">
                    <append_to_list name="$resources" exact="$ware" />
                  </do_if>
                </do_for_each>
                <debug_text text="'Entropic Resource Harvester: Mining list: ' + $resources" />
                
                <do_for_each name="$res" in="$resources">
                  <!-- Check for resource region in sector -->
                  <find_region name="$regions" space="$sector" multiple="true">
                    <match_resource ware="$res" />
                  </find_region>
                  
                  <do_if value="$regions.count gt 0">
                    <!-- Resource exists in sector. Harvest. -->
                    <!-- Get yield (density) of the resource in the sector -->
                    <get_yield space="$sector" ware="$res" result="$yield" />
                    
                    <!-- Calculate amount based on yield. Base 1000 * Yield. -->
                    <set_value name="$amount" exact="(1000 * $yield)i" />
                    
                    <debug_text text="'Entropic Resource Harvester: Found ' + $res.name + ' Yield: ' + $yield + ' Amount: ' + $amount" />
                    
                    <!-- Check storage capacity -->
                    <set_value name="$freeSpace" exact="$hq.cargo.{$res}.free" />
                    
                    <do_if value="$freeSpace gt 0">
                      <set_value name="$addAmount" exact="[$amount, $freeSpace].min" />
                      <add_cargo object="$hq" ware="$res" exact="$addAmount" />
                      <debug_text text="'Entropic Resource Harvester: Added ' + $addAmount + ' ' + $res.name" />
                    </do_if>
                  </do_if>
                </do_for_each>
              </do_if>
            </do_if>
            <reset_cue cue="this" />
          </actions>
        </cue>
      </cues>
    </cue>
  </cues>
</mdscript>
